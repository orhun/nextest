<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="`buffer_unordered_weighted` is a variant of `buffer_unordered`, where each future can be assigned a different weight."><meta name="keywords" content="rust, rustlang, rust-lang, buffer_unordered_weighted"><title>buffer_unordered_weighted - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../normalize.css"><link rel="stylesheet" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../ayu.css" disabled><link rel="stylesheet" href="../dark.css" disabled><link rel="stylesheet" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../buffer_unordered_weighted/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../buffer_unordered_weighted/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate buffer_unordered_weighted</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.1.2</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#traits">Traits</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../buffer_unordered_weighted/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">buffer_unordered_weighted</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/buffer_unordered_weighted/lib.rs.html#4-354">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p><code>buffer_unordered_weighted</code> is a variant of
<a href="https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.buffer_unordered"><code>buffer_unordered</code></a>,
where each future can be assigned a different weight.</p>
<p>This crate is part of the <a href="https://github.com/nextest-rs">nextest organization</a> on GitHub, and is
designed to serve the needs of <a href="https://nexte.st">cargo-nextest</a>.</p>
<h2 id="motivation"><a href="#motivation">Motivation</a></h2>
<p>Async programming in Rust often uses an adaptor called
<a href="https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.buffer_unordered"><code>buffer_unordered</code></a>:
this adaptor takes a stream of futures<sup id="fnref1"><a href="#fn1">1</a></sup>, and executes all the futures limited to a maximum
amount of concurrency.</p>
<ul>
<li>Futures are started in the order the stream returns them in.</li>
<li>Once started, futures are polled simultaneously, and completed future outputs are returned
in arbitrary order (hence the <code>unordered</code>).</li>
</ul>
<p>Common use cases for <code>buffer_unordered</code> include:</p>
<ul>
<li>Sending network requests concurrently, but limiting the amount of concurrency to avoid
overwhelming the remote server.</li>
<li>Running tests with a tool like <a href="https://nexte.st">cargo-nextest</a>.</li>
</ul>
<p><code>buffer_unordered</code> works well for many use cases. However, one issue with it is that it treats
all futures as equally taxing: there’s no way to say that some futures consume more resources
than others. For nextest in particular, some tests can be much heavier than others, and fewer of
those tests should be run simultaneously.</p>
<h2 id="about-this-crate"><a href="#about-this-crate">About this crate</a></h2>
<p>This crate provides an adaptor on streams called <code>buffer_unordered_weighted</code>, which can run
several futures simultaneously, limiting the concurrency to a maximum <em>weight</em>.</p>
<p>Rather than taking a stream of futures, this adaptor takes a stream of <code>(usize, future)</code> pairs,
where the <code>usize</code> indicates the weight of each future. This adaptor will schedule and buffer
futures to be run until the maximum weight is exceeded. Once that happens, this adaptor will
wait until some of the currently executing futures complete, and the current weight of running
futures drops below the maximum weight, before scheduling new futures.</p>
<p>Note that in some cases, the current weight may exceed the maximum weight. For example:</p>
<ul>
<li>Let’s say the maximum weight is <strong>24</strong>, and the current weight is <strong>20</strong>.</li>
<li>If the next future has weight <strong>6</strong>, then it will be scheduled and the current weight will become <strong>26</strong>.</li>
<li>No new futures will be scheduled until the current weight falls to <strong>23</strong> or below.</li>
</ul>
<p>It is possible to have a variant of this adaptor which always stays below the limit and holds
the next future in abeyance; however, the implementation for that variant is a bit more
complicated, and is also not the behavior desired by nextest. This variant may be provided in
the future.</p>
<p>The weight of a future can be zero, in which case it doesn’t count towards the maximum weight.</p>
<p>If all weights are 1, then <code>buffer_unordered_weighted</code> is exactly the same as <code>buffer_unordered</code>.</p>
<h2 id="examples"><a href="#examples">Examples</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>futures::{channel::oneshot, stream, StreamExt <span class="kw">as _</span>};
<span class="kw">use </span>buffer_unordered_weighted::{StreamExt <span class="kw">as _</span>};

<span class="kw">let </span>(send_one, recv_one) = oneshot::channel();
<span class="kw">let </span>(send_two, recv_two) = oneshot::channel();

<span class="kw">let </span>stream_of_futures = stream::iter(<span class="macro">vec!</span>[(<span class="number">1</span>, recv_one), (<span class="number">2</span>, recv_two)]);
<span class="kw">let </span><span class="kw-2">mut </span>buffered = stream_of_futures.buffer_unordered_weighted(<span class="number">10</span>);

send_two.send(<span class="string">&quot;hello&quot;</span>)<span class="question-mark">?</span>;
<span class="macro">assert_eq!</span>(buffered.next().<span class="kw">await</span>, <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>(<span class="string">&quot;hello&quot;</span>)));

send_one.send(<span class="string">&quot;world&quot;</span>)<span class="question-mark">?</span>;
<span class="macro">assert_eq!</span>(buffered.next().<span class="kw">await</span>, <span class="prelude-val">Some</span>(<span class="prelude-val">Ok</span>(<span class="string">&quot;world&quot;</span>)));

<span class="macro">assert_eq!</span>(buffered.next().<span class="kw">await</span>, <span class="prelude-val">None</span>);</code></pre></div>
<h2 id="minimum-supported-rust-version-msrv"><a href="#minimum-supported-rust-version-msrv">Minimum supported Rust version (MSRV)</a></h2>
<p>The minimum supported Rust version is <strong>Rust 1.56.</strong></p>
<p>The MSRV will likely not change in the medium term, but while this crate is a pre-release
(0.x.x) it may have its MSRV bumped in a patch release. Once this crate has reached 1.x, any
MSRV bump will be accompanied with a new minor version.</p>
<div class="footnotes"><hr><ol><li id="fn1"><p>This adaptor takes a stream of futures for maximum generality. In practice this is often
an <em>iterator</em> of futures, converted over using
<a href="https://docs.rs/futures/latest/futures/stream/fn.iter.html"><code>stream::iter</code></a>.&nbsp;<a href="#fnref1">↩</a></p></li></ol></div></div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.BufferUnorderedWeighted.html" title="buffer_unordered_weighted::BufferUnorderedWeighted struct">BufferUnorderedWeighted</a></div><div class="item-right docblock-short">Stream for the <a href="trait.StreamExt.html#method.buffer_unordered_weighted"><code>buffer_unordered_weighted</code></a> method.</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.StreamExt.html" title="buffer_unordered_weighted::StreamExt trait">StreamExt</a></div><div class="item-right docblock-short">An extension trait for <code>Stream</code>s that provides
<a href="trait.StreamExt.html#method.buffer_unordered_weighted"><code>buffer_unordered_weighted</code></a>.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="buffer_unordered_weighted" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>